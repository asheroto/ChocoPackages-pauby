$ErrorActionPreference = 'Stop'

# Start a new PowerShell window to wait for the "Uninstall Malwarebytes" window and close it (doing this in advance to avoid pausing script execution)
Write-Output "Launching a new PowerShell window to wait for the 'Uninstall Malwarebytes' window and close it..."
Start-Process powershell -ArgumentList "-Command", {
    $ErrorActionPreference = 'Stop'

    $timeout = 60
    $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
    while ($stopwatch.Elapsed.TotalSeconds -lt $timeout) {
        $uninstallWindow = Get-Process | Where-Object { $_.MainWindowTitle -like '*Uninstall Malwarebytes*' }
        if ($uninstallWindow) {
            $uninstallWindow | ForEach-Object { $_.CloseMainWindow() | Out-Null }
            break
        }
        Start-Sleep -Seconds 1
    }
    $stopwatch.Stop()
} -WindowStyle Minimized

# Start the uninstallation process in the original window
Write-Output "Uninstalling Malwarebytes..."
& "$ENV:ProgramFiles\Malwarebytes\Anti-Malware\mbuns.exe" -nosurvey -uninstall -silent